<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- ------------------------------------------- -->
	<!-- Simple Line Icons CSS (font + style) -->
	<link rel="stylesheet" 
		href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.css">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" 
		href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" 
		crossorigin="anonymous">
	<link rel="stylesheet" href="./css/form-factory.css">
	<!-- Custom CSS -->
	<style>
	.react-alert {
		margin-top: 1rem;
		color: #856404;
		background-color: #fff3cd;
		border-color: #ffeeba;
		position: relative;
		padding: .75rem 1.25rem;
		margin-bottom: 1rem;
		border: 1px solid transparent;
		border-radius: .25rem;
	}
	</style>
	<!-- --- -->
	<title>hyperApp - Bilety Zlot 2019</title>
</head>

<body>
	<!--
	<section class="container-fluid summit-header" style="text-align: center; margin-bottom: 40px;">
		<div style="padding-top: 10px;"> <img src="img/zlot_logo_blue_2x.png" width="200" height="68"> </div>
		<h1 class="section-header"> Zlot Programistów Delphi 2019 </h1>
		<h5 class="text-muted"> 4-5 czerwca 2019, Mszczonów </h5>
	</section>
	
	<section class="jumbotron py-3 text-center" id="kup-bilety">
		<div class="container">
			<h1 class="jumbotron-heading"><i class="icon-note"></i> Kup bilety </h1>
			<div class="h5">Zarejestruj udział firmy / udział indywidualny w zlocie i kup bilety</div>
		</div>
	</section>
	-->
	
	<main class="container" id="buy-ticket-section">
	</main>

	<style>
			.confirm-list span { 
				margin-left: 0.3em;
			},
	</style>

	<section id="confirmation-box-section" class="container mb-5" style="display: none;">
		<div class="alert alert-success" role="alert">
			<h4 class="alert-heading">Propozycja wykładu została zarejestrowana</h4>
			<hr>
			<ul class="confirm-list">
				<li><strong>Osoba zgłąszająca</strong>:<span id="out-fullname"></span></li>
				<li><strong>Stanowisko</strong>:<span id="out-position"></span></li>
				<li><strong>Email</strong>:<span id="out-email"></span></li>
				<li><strong>Telefon</strong>:<span id="out-phone"></span></li>
			</ul>
			<hr>
			<ul class="confirm-list">
				<li><strong>Liczba biletów</strong>:<span id="out-tickets"></span></li>
				<li><strong>Cena 1 biletu</strong>:<span id="out-price"></span></li>
			</ul>
			<hr>
			<ul class="confirm-list">
				<li><strong>Nazwa firmy</strong>:<span id="out-company"></span></li>
				<li><strong>Adres firmy</strong>:<span id="out-address"></span></li>
				<li><strong>Kod pocztowy</strong>:<span id="out-postalcode"></span></li>
				<li><strong>Miasto</strong>:<span id="out-city"></span></li>
				<li><strong>NIP</strong>:<span id="out-nip"></span></li>
				<li><strong>ID rejestracji</strong>:<span id="out-hash"></span></li>
			</ul>
		</div>
	</section>
	

	<footer class="mt-5 py-3 text-center bg-dark text-white">
		(c) 2019 BSC Polska
	</footer>
		
	<noscript> You need to enable JavaScript to run this app. </noscript>
	
	<!-- Optional JavaScript -->
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<!--
	<script src="http://code.jquery.com/jquery-3.3.1.min.js"
		integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		crossorigin="anonymous"></script>
		-->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" 
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" 
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" 
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" 
		crossorigin="anonymous"></script>
	<!--
	<script src="./assets/js/bootstrap-4.3.1/bootstrap.min.js"></script>
	-->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" 
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" 
		crossorigin="anonymous"></script>
	<!-- *********************** -->
	<script src="https://unpkg.com/hyperapp@1.2.9"></script>
	<script src="fake-fill-ticket-form.js"></script>
	<script src="modal.js"></script>
	<script src="form-generator.js"></script>
	<script src="light-ajax-http.js"></script>
	
	<!-- *********************** -->
	<script>

/* ------------------------------------------------------------------------
 * Form as Object polyfill
 * file: html-form-as-object.js
 * ------------------------------------------------------------------------ */

 HTMLFormElement.prototype.asObject = function () {
	const dataArr = Array.from( (new FormData(this)).entries());
	const obj = dataArr.reduce(
		function(acc, item){ acc[item[0]]=item[1]; return acc; },
		{}
	);
	return obj;
};

const ticketPrice = 799

const ticketFormSubmit = {
	apiURL: "https://delphi.pl/zlot/zlot2019/api/ticket/",
	formDefinition: {
		formID: "form-ticket",
		model : [{ 
			rowType: "section",
			title: "Osoba rejestrujaca" 
		},{ 
			rowType: "two-columns",
			fields: [{
				fieldType: "text",
				name: "person", 
				caption: "Imię i nazwisko", 
				feedback: "Proszę wprowadzić imię i nazwisko",
				isRequired: true
			},{
				fieldType: "text",
				name: "position", 
				caption: "Stanowisko", 
				feedback: "Proszę wprowadzić stanowisko",
				isRequired: true
			}]
		},{ 
			rowType: "two-columns",
			fields: [{
				fieldType: "email",
				name: "email", 
				caption: "Email", 
				feedback: "Proszę wprowadzić adres email",
				// <input type="email" />
				isRequired: true
			},{
				fieldType: "text",
				name: "phone", 
				caption: "Telefon (najlepiej mobilny)", 
				feedback: "Proszę wprowadzić nr telefonu",
				isRequired: true
			}]
		},{ 
			rowType: "section",
			title: "Bilety" 
		},{ 
			rowType: "ext-tickets",
			ticketValue: ticketPrice,
			select: {
				id: "tickets",
				caption: "Liczba biletów",
				range: {min:1, max:7},
			},
			total: {
				id: "totalTicketValue",
				caption: "Koszt całkowity netto"
			}
		},{ 
			rowType: "section",
			title: "Dane do faktury" 
		},{ 
			rowType: "two-columns",
			fields: [{
				fieldType: "text",
				name: "company", 
				caption: "Nazwa firmy", 
				feedback: "Proszę wprowadzić nazwę firmy lub imię i nazwisko w przypadku osoby prywatnej",
				isRequired: true
			},{
				fieldType: "text",
				name: "address", 
				caption: "Adres", 
				feedback: "Proszę wprowadzić adres firmy",
				isRequired: true
			}]
		},{ 
			rowType: "two-columns",
			fields: [{
				fieldType: "text",
				name: "postalCode", 
				caption: "Kod pocztowy", 
				feedback: "Proszę wprowadzić kod pocztowy",
				isRequired: true
			},{
				fieldType: "text",
				name: "city", 
				caption: "Miasto", 
				feedback: "Proszę wprowadzić miasto",
				isRequired: true
			}]
		},{ 
			rowType: "two-columns",
			fields: [{
				fieldType: "text",
				name: "nip", 
				caption: "NIP", 
				feedback: "Proszę wprowadzić NIP firmy lub n/d w przypadku osoby prywatnej",
				isRequired: true
			}]
		},{
			rowType: "confirm-gdpr",
			name: "giodo_agree",
			caption: "Zgoda na przetwarzanie danych.",
			feedback: "Pole musi zostać zaznaczone. Bez zgody na przetwarzanie danych osobowych nie możemy przyjać Państwa rejestracji.",
			description: "Wyrażam zgodę na przetwarzanie moich danych osobowych w celach marketingowych. Wyrażam zgodę na otrzymywanie od BSC Polska Sp. z o.o, informacji handlowych dotyczących produktów i usług oferowanych przez firmę. Zgodnie z Rozporządzeniem Parlamentu Europejskiego i Rady (UE) 2016/679 z dnia 27 kwietnia 2016 r. w sprawie ochrony osób fizycznych w związku z przetwarzaniem danych osobowych i w sprawie swobodnego przepływu takich danych oraz uchylenia dyrektywy 95/46/WE (RODO/GDPR).",
			isRequired: true
		},{
			rowType: "submit",
			caption: "Zarejestruj się",
			withSpinner: true,
			busyCaption: "Trwa zgłaszanie..."
		}]
	},
	// -- end: formDefinition -----------------------------------------
	init: function ( {rootElementID} ) {
		// ------------------------------
		// Modal window
		this.httpModal = new ModalWindow ('modal-win-http');
		// ------------------------------
		formRedererHyperApp.generate({
			containerId: rootElementID,
			definition: this.formDefinition,
			hyperapp: window.hyperapp,
			submitEvent: this.onFormSubmit.bind(this)
		});
		setTimeout ( ()=> {
			this.form = document.getElementById(this.formDefinition.formID);
			// this.confirmBox = document.getElementById(this.divConfirmationId);
			this.submitButton =  $(this.form).find(':submit');
		} )
	},
	__convertDataFormToApi: function (formData) {
		const price = formData.ticketValue || ticketPrice
		var apiData = {};
		apiData.fullname =  formData.person, 
		apiData.position = 	formData.position, 
		apiData.email = 	formData.email, 
		apiData.phone = 	formData.phone, 
		apiData.price = 	price, 
		apiData.tickets = 	formData.tickets, 
		apiData.company = 	formData.company,
		apiData.address = 	formData.address, 
		apiData.postalcode = formData.postalCode, 
		apiData.city =  	formData.city, 
		apiData.nip =   	formData.nip 
		return apiData;
	},
	__setSubmitButtonCaption: function (version) {
		if (version === 0) {
			$(this.submitButton).find('span.default-submit').show();
			$(this.submitButton).find('span.busy-submit').hide();
		} else {
			$(this.submitButton).find('span.default-submit').hide();
			$(this.submitButton).find('span.busy-submit').show();
		}
	},
	__reportSubmitOK: function (obj) {
		var s1 = JSON.stringify(obj)
		var s2 = s1.replace (/(",")/g, '", "')
		console.log(s2)
		var modal = new ModalWindow ('modal-win-report')
		modal.showInfo ({
			title:'Zgłoszono rejestrację', 
			info: '<div class="h1 text-success text-center mb-0 icon-check"></div>'+
				'<p class="text-center">Dane poprawne</p>'+
				'<h5>JSON do wysłania:</h5><code class="small">'+s2+'</code>'
		})
	},
	__fillHtmlConfirmationBox(data) {
		document.getElementById("buy-ticket-section").style.display = "none";
		document.getElementById("confirmation-box-section").style.display = "block";
		for (var key in data) {
    		if (data.hasOwnProperty(key)) {
				var outElem = document.getElementById("out-"+key)
				if (outElem) {
					outElem.innerHTML = data[key]
				}
			}
		}
	},
	__showToast: function(email){
		console.log( '[Toast] Notification send to: '+email )
	},
	onSendNotification: function(hash,email) {
		url = this.apiURL + 'notify/' + hash
		console.log( 'Requesting registration notification: GET '+url )
		self = this
		AjaxHttpGet(url, (response) => self.__showToast(email) )
	},
	onSendSuccess: function(response) {
		this.__setSubmitButtonCaption(0);
		// this.animateToTop();
		var data = this.formIntpuData;
		if (response.hasOwnProperty('hash')) { 
			data.hash = response.hash; 
		}
		this.__fillHtmlConfirmationBox(data)
		self = this
		setTimeout(
			()=>self.onSendNotification(data.hash,data.email), 
			100);
	},
	onSendFailure: function(status,response) {
		this.__setSubmitButtonCaption(0);
		const modal = new ModalWindow ('modal-win-report')
		if (status>0) {
			modal.showDanger ({
				title: 'Błąd połączenia z serwerem danych',
				info: '<p>Podczas przekazywania danych rejestracyjnych wystąpił błąd<p><hr><h5>Status błędu:</h5><p>'+status+'</p><h5>Komunikat błędu:</h5><p>'+response+'</p>'
			});
		} else {
			modal.showDanger ({
				title: 'Niepoprawna odpowiedź serwera',
				info: '<p>Odpowiedź serwera niezgodna z formatem JSON.</p><h5>Komunikat serwera:</h5><p>'+response+'</p>'
			});
		}
	},
	onFormSubmit: function () {
		const isValid = this.form.checkValidity()
		this.form.classList.add('was-validated')
		if (isValid) {
			this.__setSubmitButtonCaption(1);
			const fd = this.form.asObject()
			const data = this.__convertDataFormToApi (fd)
			this.formIntpuData = data
			self = this
			
			// self.onSendSuccess({hash: '16f83ef4776d'})  // bogdan.polak@bsc.com.pl
			self.onSendSuccess({hash: '00087365ba1b'})  // bogdan.polak@wp.pl
			/*
			AjaxHttpPut(this.apiURL, data, 
				(response) => self.onSendSuccess(response), 
				(status,response) => self.onSendFailure(status,response) )
			*/
		}
	}

}

ticketFormSubmit.init( {rootElementID: "buy-ticket-section" } )

	</script>
	<!-- *********************** -->
</body>

</html>